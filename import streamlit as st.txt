import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px

# Cargar datos
df = pd.read_csv("Estaciones_Pptn_Todas.csv")

# Ajuste de nombres y estructura de los datos
df.rename(columns={df.columns[0]: "Año"}, inplace=True)
df["Año"] = df["Año"].astype(int)

# Sidebar - Selección de estaciones y rango de años
estaciones = df.columns[1:]
año_min, año_max = df["Año"].min(), df["Año"].max()

st.sidebar.title("Opciones de filtro")
estaciones_seleccionadas = st.sidebar.multiselect("Selecciona estaciones", estaciones, default=estaciones)
rango_años = st.sidebar.slider("Selecciona rango de años", min_value=int(año_min), max_value=int(año_max), value=(int(año_min), int(año_max)))

# Filtrar datos
df_filtrado = df[(df["Año"] >= rango_años[0]) & (df["Año"] <= rango_años[1])][["Año"] + list(estaciones_seleccionadas)]

# Tabs de contenido
tabs = st.tabs(["Tabla de Datos", "Gráficos", "Estadísticas"])

# --- TABLA ---
with tabs[0]:
    st.subheader("Tabla de precipitaciones")
    st.dataframe(df_filtrado, use_container_width=True)

# --- GRÁFICOS ---
with tabs[1]:
    st.subheader("Visualización de Datos")
    tipo_grafico = st.radio("Tipo de gráfico", ["Línea", "Barras", "Boxplot"], horizontal=True)

    df_melt = df_filtrado.melt(id_vars=["Año"], var_name="Estacion", value_name="Precipitacion")

    if tipo_grafico == "Línea":
        fig = px.line(df_melt, x="Año", y="Precipitacion", color="Estacion", markers=True)
    elif tipo_grafico == "Barras":
        fig = px.bar(df_melt, x="Año", y="Precipitacion", color="Estacion", barmode="group")
    elif tipo_grafico == "Boxplot":
        fig = px.box(df_melt, x="Estacion", y="Precipitacion")

    st.plotly_chart(fig, use_container_width=True)

# --- ESTADÍSTICAS ---
with tabs[2]:
    st.subheader("Estadísticas Básicas")

    df_stats = df_filtrado.describe().transpose()[["mean", "min", "max"]].rename(columns={
        "mean": "Promedio",
        "min": "Mínimo",
        "max": "Máximo"
    })

    # Obtener años de mínimo y máximo
    estaciones_stats = []
    for estacion in estaciones_seleccionadas:
        min_val = df_filtrado[estacion].min()
        max_val = df_filtrado[estacion].max()
        anio_min = df_filtrado[df_filtrado[estacion] == min_val]["Año"].values[0]
        anio_max = df_filtrado[df_filtrado[estacion] == max_val]["Año"].values[0]
        estaciones_stats.append({
            "Estacion": estacion,
            "Promedio": round(df_filtrado[estacion].mean(), 2),
            "Mínimo": f"{min_val} ({anio_min})",
            "Máximo": f"{max_val} ({anio_max})"
        })

    st.dataframe(pd.DataFrame(estaciones_stats).set_index("Estacion"), use_container_width=True)

st.caption("Desarrollado con Streamlit - Visualizador de precipitación anual")